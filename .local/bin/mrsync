#!/bin/bash

scriptname="$(basename "${BASH_SOURCE[0]}")"
rundir="${XDG_RUNTIME_DIR:-${HOME}/.local/var/run}/${scriptname}"
mkdir -p "${rundir}"

exec 200<"$(readlink -f "${BASH_SOURCE[0]}")"
if ! flock -n 200 || ! echo "$$" > "${rundir}/PID"; then
    echo "another instance of the ${scriptname} is currently running..." >&2
    exit 1
fi
trap 'flock -u 200 && rm -f "${rundir}/PID"' EXIT SIGHUP SIGINT SIGQUIT SIGTERM

pkill -RTMIN+5 i3blocks

if ! sshpass mr -j 10 -d "${HOME}" commit -S -m autocommit; then
    touch "${rundir}/mr.error"
fi

# use sshpass to get around gpg problems with encrypted repos...
if ping -c 1 squid.stillwell.me >/dev/null 2>&1; then
    if sshpass mr -d "${HOME}" autopush; then
        rm -f "${rundir}/mr.error"
    else
        touch "${rundir}/mr.error"
    fi
fi

exit 0
